<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Hair AI Demo</title>
<style>
  body { background: #222; color: white; text-align: center; font-family: sans-serif; }
  video, canvas { border-radius: 10px; }
  #hair-options img { width: 100px; height: auto; margin: 5px; cursor: pointer; border: 2px solid transparent; }
  #hair-options img.selected { border-color: yellow; }
</style>
</head>
<body>

<h1>AI ออกแบบทรงผม Realtime</h1>
<video id="video" width="640" height="480" autoplay playsinline></video>
<canvas id="output" width="640" height="480"></canvas>

<h2>เลือกทรงผม</h2>
<div id="hair-options"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
const videoElement = document.getElementById('video');
const canvasElement = document.getElementById('output');
const canvasCtx = canvasElement.getContext('2d');
const hairOptionsDiv = document.getElementById('hair-options');

// ทรงผมที่เตรียมไว้
const hairImages = [
  'assets/hair1.png',
  'assets/hair2.png',
  'assets/hair3.png'
];

let selectedHair = null;
const loadedHairImgs = hairImages.map(src => {
  const img = new Image();
  img.src = src;
  return img;
});

function detectFaceShape(landmarks) {
  const jawWidth = Math.abs(landmarks[234].x - landmarks[454].x);
  const faceHeight = Math.abs(landmarks[10].y - landmarks[152].y);
  const ratio = jawWidth / faceHeight;
  if (ratio > 0.8) return 'Square';
  if (ratio > 0.6) return 'Oval';
  return 'Round';
}

function renderHairOptions() {
  hairOptionsDiv.innerHTML = '';
  hairImages.forEach((src, idx) => {
    const img = document.createElement('img');
    img.src = src;
    img.onclick = () => {
      document.querySelectorAll('#hair-options img').forEach(e => e.classList.remove('selected'));
      img.classList.add('selected');
      selectedHair = loadedHairImgs[idx];
    };
    hairOptionsDiv.appendChild(img);
  });
}

renderHairOptions();

const faceMesh = new FaceMesh({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
});
faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});
faceMesh.onResults(results => {
  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
  canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

  if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
    const landmarks = results.multiFaceLandmarks[0];

    if (selectedHair) {
      const forehead = landmarks[10];
      const chin = landmarks[152];
      const faceHeight = Math.abs(forehead.y - chin.y) * canvasElement.height;
      const hairHeight = faceHeight * 1.2;
      const hairWidth = hairHeight;

      const x = (forehead.x * canvasElement.width) - (hairWidth / 2);
      const y = (forehead.y * canvasElement.height) - (hairHeight * 0.6);

      canvasCtx.drawImage(selectedHair, x, y, hairWidth, hairHeight);
    }
  }
});

const camera = new Camera(videoElement, {
  onFrame: async () => {
    await faceMesh.send({ image: videoElement });
  },
  width: 640,
  height: 480
});
camera.start();
</script>

</body>
</html>
